name: Auto Update FFmpeg

on:
  schedule:
    # Run daily at 10:00 UTC
    - cron: '0 10 * * *'
  workflow_dispatch: # Allow manual triggering

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for new FFmpeg version
        id: check_version
        run: |
          # Get current version from formula
          CURRENT_VERSION=$(grep -oP '(?<=ffmpeg-)[0-9]+\.[0-9]+(\.[0-9]+)?' Formula/ffmpeg.rb | head -1)
          echo "Current version: $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Fetch the latest version from FFmpeg releases page
          LATEST_VERSION=$(curl -sL https://ffmpeg.org/releases/ | \
            grep -oP 'ffmpeg-\K[0-9]+\.[0-9]+(\.[0-9]+)?(?=\.tar\.xz)' | \
            sort -V | tail -1)
          echo "Latest version: $LATEST_VERSION"
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

          # Compare versions
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "New version available: $LATEST_VERSION"
            echo "update_available=true" >> $GITHUB_OUTPUT
          else
            echo "Already up to date"
            echo "update_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Download, verify signature, and calculate SHA256
        if: steps.check_version.outputs.update_available == 'true'
        id: download
        run: |
          VERSION=${{ steps.check_version.outputs.latest_version }}
          URL="https://ffmpeg.org/releases/ffmpeg-${VERSION}.tar.xz"
          TARBALL="ffmpeg-${VERSION}.tar.xz"
          SIGNATURE="${TARBALL}.asc"

          echo "Downloading $URL and signature"
          wget -q "$URL"
          wget -q "${URL}.asc"

          echo "Importing FFmpeg GPG key"
          curl -sL https://ffmpeg.org/ffmpeg-devel.asc | gpg --import

          echo "Verifying GPG signature"
          gpg --verify "$SIGNATURE" "$TARBALL"

          if [ $? -ne 0 ]; then
            echo "❌ GPG signature verification failed!"
            exit 1
          fi
          echo "✅ GPG signature verified successfully"

          SHA256=$(sha256sum "$TARBALL" | awk '{print $1}')
          echo "SHA256: $SHA256"
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT

          # Clean up
          rm "$TARBALL" "$SIGNATURE"

      - name: Update formula
        if: steps.check_version.outputs.update_available == 'true'
        run: |
          VERSION=${{ steps.check_version.outputs.latest_version }}
          SHA256=${{ steps.download.outputs.sha256 }}
          URL=${{ steps.download.outputs.url }}

          # Update the URL line
          sed -i "s|url \"https://ffmpeg.org/releases/ffmpeg-.*\.tar\.xz\"|url \"$URL\"|" Formula/ffmpeg.rb

          # Update the SHA256 line
          sed -i "s|sha256 \".*\"|sha256 \"$SHA256\"|" Formula/ffmpeg.rb

          echo "Formula updated to version $VERSION"

      - name: Create Pull Request
        if: steps.check_version.outputs.update_available == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update FFmpeg to ${{ steps.check_version.outputs.latest_version }}"
          title: "Update FFmpeg to ${{ steps.check_version.outputs.latest_version }}"
          body: |
            ## FFmpeg Version Update

            This PR updates FFmpeg from `${{ steps.check_version.outputs.current_version }}` to `${{ steps.check_version.outputs.latest_version }}`.

            ### Changes

            - **Version**: `${{ steps.check_version.outputs.latest_version }}`
            - **URL**: `${{ steps.download.outputs.url }}`
            - **SHA256**: `${{ steps.download.outputs.sha256 }}`

            ### Release Notes
            Check the [FFmpeg changelog](https://ffmpeg.org/index.html#news) for details.

            ---

            This PR was automatically created by the Auto Update FFmpeg workflow.
          branch: auto-update-ffmpeg-${{ steps.check_version.outputs.latest_version }}
          delete-branch: true
          labels: |
            automation
            ffmpeg-update
